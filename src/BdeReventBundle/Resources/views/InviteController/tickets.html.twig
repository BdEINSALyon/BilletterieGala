{% extends "::public.html.twig" %}

{% block title %}Billetterie{% endblock %}

{% block content %}
    <div class="row" id="loading">
        <div class="col-md-12" style="text-align: center">
            <i class="fa fa-circle-o-notch fa-spin"></i> Chargement de la boutique ...
        </div>
    </div>
    <div id="tickets" style="display: none;">
        <a title="Logiciel billetterie en ligne" href="https://www.weezevent.com//?c=sys_widget"
           class="weezevent-widget-integration" target="_blank"
           data-src="https://weezevent.bde-insa-lyon.fr/widget_billeterie.php?id_evenement=145887&amp;lg_billetterie=1&amp;code=41759&amp;resize=1&amp;width_auto=1&amp;color_primary=52bdb6"
           data-width="650" data-height="600" data-id="145887" data-resize="1" data-width_auto="1" data-noscroll="1"
           data-nopb="1">Billetterie Weezevent</a>
        <script type="text/javascript" src="{{ asset("bundles/bderevent/js/widget.js") }}"></script>
    </div>
    <script>
        document.domain = "bde-insa-lyon.fr";
        window.userToken = "{{ token }}";
        window.mobileAndTabletcheck = function () {
            var check = false;
            (function (a) {
                if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4)))check = true
            })(navigator.userAgent || navigator.vendor || window.opera);
            return check;
        }
    </script>
    <div class="hide" id="popup-content">
        <div onclick="$('.security_info_wrapper').fadeOut(2)" id="security_info_close">x</div>
        <p>Vous êtes sur un espace sécurisé utilisant un protocle SSL de cryptage de vos données, certifié par Comodo.
            Vous pouvez en vérifier la validité en cliquant sur l'icône du certificat Comodo.</p>

        <p>Ce protocole de sécurité utilise également la norme HTTPS (au lieu du HTTP)
            depuis les serveurs de bde-insa-lyon.fr.</p>

        <p>Si votre banque l'a activé, le paiement s'effectuera par 3DSecure. Cela garantie la transaction, un code vous
            sera demandé par votre banque.</p>
        <span style="display: none">BdE INSA Lyon</span>
        <div class="logo_block" style="padding-left: 65px">
            <div id="block_cic"></div>
            <div id="block_visa"></div>
            <div id="block_master"></div>
            <div onclick="window.open('https://secure.comodo.com/ttb_searcher/trustlogo?v_querytype=W&v_shortname=CL1&v_search=https://weezevent.bde-insa-lyon.fr/&x=6&y=5')"
                 style="background: url('https://ssl.comodo.com/images/trustlogo/comodo_secure_113x59_transp.png');height: 59px;width:113px; margin-top: -20px; margin-bottom: auto"></div>
        </div>
    </div>
    <script>
        var participant = {{ pjson|raw }};
        $(function () {
            var trustSection = function () {
                try {
                    var $2 = $($("iframe")[0].contentDocument);
                    var $content = $('#popup-content');
                    if (!$2.find('#security_info_popin').html().includes("BdE INSA Lyon")) {
                        $2.find("#venteSupenduesOrgaInfo").hide();
                        $2.find(".flags").hide();
                        $2.find('#security_info_popin').attr("style", 'height:250px');
                        $2.find('#security_info_popin').html($content.html());
                    }
                } catch (ex) {
                }
                return 0;
            };
            $('iframe').load(trustSection);
        });
        $(function () {
            var testBuy = function () {
                try {
                    var $2 = $($("iframe")[0].contentDocument);
                    var test = $2.find(".downloadTicketButton").length;
                    test += $2.find(".message_confirmation_title").length;
                    test += $2.find("#big_check").length;
                    if (test > 0) {
                        $2.find("#venteSupenduesOrgaInfo").hide();
                        console.log("Achat fini!");
                        $.post("{{ url('end_payment', {key: token}, true) }}", {nbInvite: window.nbInvites}, function (data) {
                            console.log(data);
                        });

                        if ("{{ participant.type.canInvite }}" == "1") {
                            var $invite = $("#invite");
                            $invite.hide();
                            $invite.removeClass("hide");
                            $invite.fadeIn(1500);
                        }
                        return 1;
                    }
                } catch (ex) {
                }
                return 0;
            };
            window.checkBuy = true;
            $('iframe').load(testBuy);
        });
        window.nbInvites = 0;
        $(function () {
            var recall = function () {
                if (!hookForm())
                    setTimeout(recall, 500);
            };
            var informationHook = function () {
                try {
                    var $2 = $($("iframe")[0].contentDocument);
                    if ($2.find("input[name='current_step']").val() == 'form') {
                        $2.find("#champs_3_0").val(participant.firstname);
                        $2.find("#champs_2_0").val(participant.lastname);
                        $2.find("#champs_5_0").val(participant.email);
                        $2.find("#champs_5_0").after('<span class="text-info" style="color:green; margin-top: 5px">Les billets seront envoyés à cette adresse</span>');
                        $2.find("#champs_36_0").val(participant.email);
                    }
                } catch (e) {

                }
            };
            $('iframe:first').load(informationHook);
            var hookForm = function () {
                try {
                    var $2 = $($("iframe")[0].contentDocument);
                    var test = $2.find("#submitTicketForm").length;
                    test += $2.find("input[name='current_step']").val() == 'tickets';
                    if (test > 0) {
                        var form = $2.find("#FormBilleterie");
                        form.find(".bloc_liste_billets").show();
                        form.find(".picto_cat").hide();
                        var iframeWindow = $("iframe")[0].contentWindow;
                        updateAmountTickets = function () {
                            iframeWindow.$("input[name^='id_code_cpt_']").each(function () {
                                var idPrice = iframeWindow.$(this).val();
                                var positionPrice = iframeWindow.$('#cpt_chps_' + idPrice).val();
                                var amountPrice = iframeWindow.$('#montantBilletInitial_' + positionPrice).val();
                                if (amountPrice > 0 && iframeWindow.$('#quantite_' + idPrice).val() >= 0) {
                                    iframeWindow.verifQuantitesEvMax();
                                    iframeWindow.majPrixBillet(amountPrice, idPrice, positionPrice);
                                }
                            });
                        };

                        // Demande de fagot :
                        $2.find(".close").unbind("click");
                        $2.find(".close").hide();
                        $2.find(".ticket_table_header").hide();
                        $2.find(".ticket_table_header").first().show();

                        // Mange hidden products
                        var type = "{{ participant.type.canInvite }}" == "1" ? 1 : 0;
                        var hide = [];
                        var maxTicket = 0;
                        var $errorMaxModal = $("#tooMuchPlace");
                        var $quantitySelect = $2.find(".quantitySelect");
                        switch (type) {
                            case 0:
                                hide = [
                                    "652801", // Pack S diplomé
                                    "652805", // Pack M diplomé
                                    "652800", // Pack L diplomé
                                    "652802", // Pack XL diplomé
                                    "652799"  // Pack XXL diplomé
                                ];
                                maxTicket = 1;
                                $errorMaxModal = $("#tooMuchPlaceGuest");
                                $2.find("#ticket_table_632276").find(".billetterie_tb_nom").contents().filter(function () {
                                    return this.nodeType == 3
                                }).each(function () {
                                    this.textContent = this.textContent.replace(' (1 personne invité)', '');
                                });
                                break;
                            default:
                                hide = [
                                    "652804", // Pack S invité
                                    "652806", // Pack M invité
                                    "652803", // Pack L invité
                                    "652798", // Pack XL invité
                                    "652798"  // Pack XL invité
                                ];
                                maxTicket = 8;
                                $errorMaxModal = $("#tooMuchPlaceGraduate");
                        }
                        var checkAndStore = function () {
                            var sum = 0;
                            $quantitySelect.each(function (id, select) {
                                var value = parseInt($(select).val());
                                if ($(select).attr('id') == "quantite_652799")
                                    value = value * 2;
                                sum += value;
                                window.nbInvites = (sum - 1);
                            });
                            if (sum > maxTicket) {
                                $quantitySelect.val(0);
                                updateAmountTickets();
                                $errorMaxModal.modal()
                            }
                        };
                        $quantitySelect.change(checkAndStore);

                        hide.forEach(function (value) {
                            $2.find("#ticket_table_" + value).hide();
                        });
                        form.submit(function (e) {
                            e.preventDefault();
                        });
                        $('#loading').fadeOut(500, function () {
                            $('#tickets').fadeIn(1500);
                        });
                        return 1;
                    }
                } catch (ex) {
                }
                return 0;
            };
            if (window.mobileAndTabletcheck()) {
                alert("Vous devez utiliser un ordinateur pour passer votre commande. Nous vous redirigeons vers le site du gala.");
                window.location.href = "http://gala.bde-insa-lyon.fr";
            }
            $('iframe').load(hookForm);
            function sayThatIExist() {
                $.post("{{ url('point', {key: token}, true) }}", function (data) {
                });
            }
            sayThatIExist();
            setInterval(sayThatIExist, 10000);
        })
    </script>
    <div class="modal fade" id="tooMuchInvites" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="myModalLabel">Erreur</h4>
                </div>
                <div class="modal-body">
                    Vous ne pouvez pas avoir plus de 7 invités.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Fermer ce message</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="tooMuchPlace" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="myModalLabel">Erreur</h4>
                </div>
                <div class="modal-body">
                    Vous avez atteint la limite de place !
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Fermer ce message</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="tooMuchPlaceGuest" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="myModalLabel">Erreur</h4>
                </div>
                <div class="modal-body">
                    Vous ne pouvez pas prendre prendre plus d'une place en tant qu'invité
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Fermer ce message</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="tooMuchPlaceGraduate" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="myModalLabel">Erreur</h4>
                </div>
                <div class="modal-body">
                    Vous ne pouvez pas prendre plus de 8 billets (1 pour vous et 7 invités)
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Fermer ce message</button>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2 hide col-md-offset-5" id="invite">
        <a href="{{ path('invite', {'key': token}) }}" class="btn btn-primary">Inviter des proches</a>
    </div>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset("bundles/bderevent/css/font-awesome.css") }}" type="text/css">
{% endblock %}
